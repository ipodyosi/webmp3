<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>WEBM変換</title>
  
  
  
<style>
body { 
   font-family: "Rounded Mplus 1c";
   font-size: 100%;
   /* color: #ecf0f1;
   background: #8e44ad; */
}

#kkaf {
   font-size: 1.5em;
   margin: 10px;
}


#buttonx {
  width:190px;
  color:#ffffff;
  background:#e67e22;
  font-family: fantasy,sans-serif;
  font-size:24px;
  text-shadow:0 1px 0px #143352,0 2px 0px #143352;
  text-align:center;
  display:inline-block;
  text-decoration:none;
  border:1px solid #225588;
  padding:5px 0 2px 0;
  border-radius:5px;
  margin-bottom:20px;
  margin-left:10px;
  opacity: 0.7;
}


div#footer-fixed
{
    position: fixed;
    bottom: 0px;    
    left: 0px;      
    width: 100%;    
    height: 70px;   
}
 

div#body-bk{
    padding: 0px 0 80px 0;    /* 荳九↓80px繧剃ｽ咏區繧貞叙繧? */
}

#logs {
  width: 80%;
  font-size: 1em;
}



</style>
<script src="coi-serviceworker.js"></script>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"></script>
  
</head>

<body>

  <!DOCTYPE html>
<html lang="en" >

<head>
  
  <meta charset="UTF-8">
  <title>Radio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  
</head>

<body>

     <h1>WEBMをMP3に変換</h1>



<div id="body-bk">

<div id="kkaf">
1.webmを選択<br>  
<input type="file" id="file" name="file"/ accept="audio/webm">
<br>
<br>

<div>
<audio id="output-audio" controls>
</audio>
</div>  

<div>
<textarea id="logs" rows="15"></textarea>  
</div>


</div>

</div>

<div id="footer-fixed">

<!-- <a id="buttonx" onmouseover="this.style.background='#e67e22'" onmouseout="this.style.background='#d35400'" onclick="this.style.background='#e74c3c';javascript:location.reload()">リロード</a>
<a id="buttonx" onmouseover="this.style.background='#e67e22'" onmouseout="this.style.background='#d35400'" onclick="this.style.background='#e74c3c';javascript:history.go(-1);">戻る</a> -->



</div>



<script>
  var loglog = document.getElementById('logs');
  var date = new Date();
  var fdate = date.toLocaleString('ja-JP').replace(/ /g,'-').replace(/\//g,'-').replace(/:/g,'-');
  var outfname = 'output1-' + fdate + '.mp3'
  loglog.value = 'ブラウザを更新してください。';
  const audio = document.getElementById('output-audio');
  const { createFFmpeg } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });
 
 // ページをreloadする方法
// reloadの基本的な使い方
function doReload() {

// reloadメソッドによりページをリロード
window.location.reload();
}

window.addEventListener('load', function () {

// ページ表示完了した5秒後にリロード
setTimeout(doReload, 2000);
});

  window.onload = function(){
    // ブラウザ上に表示する文字列を保持する一時変数
    let outstr = "";
    // console.logの挙動
    console.log = (...args) => {
        for(let arg of args){
            // console.logに入力された文字列を改行つきで保持
            outstr = arg +"\n"+outstr;
        }
        // HTMLのid="console"に対して文字列outstrを設定する
        loglog.value = outstr+"\n"+loglog.value;
    }
   console.clear;

    
}

  let kka;
               const myWorker = new Worker("worker.js");
                if (crossOriginIsolated) {
                const buffer = new SharedArrayBuffer(16);
                myWorker.postMessage(buffer);
                loglog.value = "MP3準備完了";
                } else {
                const buffer = new ArrayBuffer(16);
                myWorker.postMessage(buffer);
               // loglog.value = "22";
                }



//ファイル選択ボタン

// let ffmpegjs =  Comlink.proxy(worker);
// let result =  ffmpegjs({
//    arguments: ['-y','-i', file.name, 'output.webm'],
//    MEMFS: [{name: file.name, data: data}],
//    stdin: Comlink.proxyValue(() => {}),
//    onfilesready: Comlink.proxyValue((e) => {
//      let data = e.MEMFS[0].data;
//      output.src = URL.createObjectURL(new Blob([data]))
//      console.log('ready', e)
//    }),
//    print: Comlink.proxyValue(function(data) { console.log(data); stdout += data + "\n"; }),
//    printErr: Comlink.proxyValue(function(data) { console.log('error', data); stderr += data + "\n"; }),
//    postRun: Comlink.proxyValue(function(result) { console.log('DONE', result); }),
//    onExit: Comlink.proxyValue(function(code) {
//      console.log("Process exited with code " + code);
//      console.log(stdout);
//    }),
// });

var el2 = document.getElementById("file");
 
el2.addEventListener( 'change', function(e) {
  
    var result = e.target.files[0];
    
    //FileReaderのインスタンスを作成する
    var reader = new FileReader();
  
    //読み込んだファイルの中身を取得する
    reader.readAsDataURL( result );
  
    //ファイルの中身を取得後に処理を行う
    reader.addEventListener( 'load', function() {
    
        //ファイルの中身をエディター内に表示する
        //console.log(reader.result);
        (async () => {
              await ffmpeg.load();
              await ffmpeg.write('input.webm',reader.result);
              await console.log('input webm write ended');
          //    loglog.value = await 'input webm File write FS ended\n' + loglog.value;
              await ffmpeg.run('-i input.webm ' + outfname);
              await console.log('ffmpeg run ended');
          //    loglog.value = await 'input webm File convert output1 mp3 ended\n' + loglog.value;
              data = await ffmpeg.read(outfname);
              await console.log('read data ended');
          //    loglog.value = await 'output1 mp3 File set data ended\n' + loglog.value;

              await ffmpeg.remove('input.webm');
              await console.log('input.webm del ended');
          //    loglog.value = await 'input webm File delete FS ended\n' + loglog.value;

              await ffmpeg.remove(outfname);
              await console.log('output1.mp3 del ended');
          //    loglog.value = await 'output1 mp3 File delete FS ended\n' + loglog.value;

              audio.src = URL.createObjectURL(new Blob([data.buffer], {
                type: 'audio/mp3'
              }));

               var a = document.createElement('a');
              a.href = URL.createObjectURL(new Blob([data.buffer], {  type: 'audio/mp3' }));
              a.download = result.name+'.mp3'
              a.click();


              loglog.value = await result.name+'.mp3'+'作成完了!!!\n';

             // msg = await alert('MP3変換完了。ダウンロードできます');

        })();
    })
 
})





</script>


</body>

</html>
  
  