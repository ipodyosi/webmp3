<!DOCTYPE html>
<html lang="ja">
<title>SpeechAPI</title>

<body>


        <button id="speak-btn">再生</button><br>
        <textarea style="background-color:lightblue"cols="60" rows="15"  id="text">発言</textarea><br><br>
        <textarea style="background-color:lightblue"cols="60" rows="15"  id="logtext"></textarea><br><br>
        <audio controls id="audio"></audio>

</body>
<script src="coi-serviceworker.js"></script>
<script src="./TtsQuestV3Voicevox.js"></script>
<script>
    const speakBtn    = document.querySelector('#speak-btn')
    const text        = document.querySelector('#text')
    const logtext        = document.querySelector('#logtext')
    const audio = document.querySelector('#audio')
    
    speakBtn.addEventListener('click', function() {
        play();
   
        
 
        })

        function play() {
            var speakerId = 1; // VOICEVOX:ずんだもん（あまあま）
            var text = document.getElementById('text').value;
            var ttsQuestApiKey = 'g49643w0d87737H' // optional
            var audio2 = new TtsQuestV3Voicevox(speakerId, text, ttsQuestApiKey);
            setTimeout(() => {
           
               soundPlay(audio2.src);
              
            }, 3000);
            }

            const soundPlay = function(url) {
            audio.onerror = function() {
                // エラー時の処理
                console.log("再生できませんでした");
                setTimeout(() => {
                    play();
                }, 3000);
                
            }
            // URL設定

           audio.src = url;
            // 再生(できないときはエラーに行く)
            audio.play();
            const a = document.createElement('a');
             a.style.display = 'none';
             a.href = url;
             a.download = '111.mp3';
             document.body.appendChild(a);
             a.click();
            
        }



//     async function VoiceVoxMake(){
//         let form = new FormData();
//         form.append("parameter", "parameter");
//         audio.src='';

//         const url = "https://api.tts.quest/v3/voicevox/synthesis?text="+text.value+ "&speaker=2" + "&key=" +"L8683220Q-3539g";
//         fetch(url, {
//         　　　　　　　　method: 'POST',
//         　　　　　　　　body: form,
//         })
//         .then(response =>  response.text())
//         .then(data => {
//         console.log(data)
//         var newdata=data.replace(/\\|\\/g,"")
        
//         var okcheck=newdata.slice(11,13);
//       //  logtext.value=data;
       
//        setTimeout(() => {
 
//             if(okcheck=="tr"){
//                     var Siti=newdata.indexOf('mp3DownloadUrl');
//                     var Eiti = newdata.indexOf("audio.mp3");
//                     var SIti2 =Siti+17;// newdata.indexOf("audioStatusUrl")
//                     var Eiti2 = Eiti;//newdata.indexOf("status.json")
//                     var downURL=newdata.slice(SIti2,Eiti2+9);
//                     logtext.value=""
//                     setTimeout(() => {
//                             fileDownloadFromUrl(newdata,"test.mp3",downURL);
//                         //   logtext.value=data;
//                     }, 1000);
//              }else{
//                 logtext.value="現在作成中です。少しお待ちください。"
//                 var Siti=newdata.indexOf('retryAfter');
//                 var Eiti = newdata.indexOf("}");
//                 var SIti2 =Siti+12;
//                 var downURL=newdata.slice(SIti2,Eiti);
//                 var down=downURL*1000
//                 setTimeout(() => {
                   
//                     VoiceVoxMake();
//                 }, down);
//              }
      
//         }, 500);
//     })

        
//     }

//     async function fileDownloadFromUrl(newdata,fileName, fileUrl) {
//         var SIti3 = newdata.indexOf("audioStatusUrl")
//         var Eiti3 = newdata.indexOf("wavDownloadUrl")
//       //  logtext.value=newdata;
//         var Js3 = newdata.slice(SIti3+17 ,Eiti3-3 )
//       //  logtext.value=Js3;
   
//         let form = new FormData();
//         form.append("parameter", "parameter");
//         const url = Js3;
//         fetch(url, {
//         　　　　　　　　method: 'POST',
//         　　　　　　　　body: form,
//         })
//         .then(response =>  response.text())
//         .then(data2 => {
//         var okcheck=data2.slice(11 ,13);
//         setTimeout(() => {
//                 if (okcheck="tr"){
 
//                     audio.src=fileUrl;
//                 }else{
//                     //fileDownloadFromUrl(newdata,"test.mp3",downURL);  
//                 }
//             }, 2000);       



//      //   logtext.value=data2

      
//     })

//     // function play() {
//     //     var speakerId = 1; // VOICEVOX:ずんだもん（あまあま）
//     //     var text = document.getElementById('text').value;
//     //     var ttsQuestApiKey = '' // optional
//     //     var audio2 = new TtsQuestV3Voicevox(speakerId, text, ttsQuestApiKey);
//     //     audio2.play();
//     //     }

// }


</script>
  